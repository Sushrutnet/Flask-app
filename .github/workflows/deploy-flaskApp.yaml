name: Build and Deploy Flask App 

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker, Minikube, and kubectl (using minikubesetup.sh)
      run: |
        chmod +x MinikubeSetupScript.sh
        ./MinikubeSetupScript.sh

  build-and-push:
    runs-on: self-hosted
    needs: setup

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t sushrutnet/flask-app:$GITHUB_SHA .
        docker push sushrutnet/flask-app:$GITHUB_SHA

  deploy:
    runs-on: self-hosted
    needs: build-and-push

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up kubectl
      uses: actions/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f deployment.yaml

    - name: Verify Deployment
      run: |
        kubectl rollout status deployment/flask-app || (echo "Deployment failed!" && exit 1)

  notify:
    runs-on: ubuntu-latest
    if: failure()
    needs: deploy

    steps:
    - name: Send Slack notification
      run: |
        curl -X POST -H 'Content-type: application/json' --data '{"text":"Deployment failed for Flask app."}' $SLACK_WEBHOOK_URL
